##
## Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
##
## This file is part of ewm-cloud-robotics
## (see https://github.com/SAP/ewm-cloud-robotics).
##
## This file is licensed under the Apache Software License, v. 2 except as noted otherwise in the LICENSE file (https://github.com/SAP/ewm-cloud-robotics/blob/master/LICENSE)
##

apiVersion: skaffold/v1beta11
kind: Config

## Default profile:
## Use local Docker daemon & registry to build and test all images, then exit without deployment
## to verify that builds and tests are OK. 
build:
  artifacts:
    - image: ewm-sim
      context: docker/ewm-sim/
      docker:
        dockerfile: Dockerfile
    - image: dummy-mission-controller
      context: .
      docker:
        dockerfile: docker/dummy-mission-controller/Dockerfile
    - image: fetch-mission-controller
      context: .
      docker:
        dockerfile: docker/fetch-mission-controller/Dockerfile
    - image: mir-mission-controller
      context: .
      docker:
        dockerfile: docker/mir-mission-controller/Dockerfile
    - image: order-manager
      context: .
      docker:
        dockerfile: docker/order-manager/Dockerfile
    - image: robot-controller
      context: .
      docker:
        dockerfile: docker/robot-controller/Dockerfile
    - image: robot-configurator
      context: .
      docker:
        dockerfile: docker/robot-configurator/Dockerfile
    - image: monitoring-ui
      context: .
      docker:
        dockerfile: docker/monitoring-ui/Dockerfile
    - image: order-auctioneer
      context: .
      docker:
        dockerfile: docker/order-auctioneer/Dockerfile
    - image: order-bid-agent
      context: .
      docker:
        dockerfile: docker/order-bid-agent/Dockerfile
    - image: mir-runtime-estimator
      context: .
      docker:
        dockerfile: docker/mir-runtime-estimator/Dockerfile
  local: 
    push: false
test:
  - image: ewm-sim
    structureTests:
      - docker/ewm-sim/test/container-structure-test/prod.yaml
  - image: dummy-mission-controller
    structureTests:
      - docker/dummy-mission-controller/test/container-structure-test/prod.yaml
  - image: mir-mission-controller
    structureTests:
      - docker/mir-mission-controller/test/container-structure-test/prod.yaml
  - image: fetch-mission-controller
    structureTests:
      - docker/fetch-mission-controller/test/container-structure-test/prod.yaml
  - image: order-manager
    structureTests:
      - docker/order-manager/test/container-structure-test/prod.yaml
  - image: robot-controller
    structureTests:
      - docker/robot-controller/test/container-structure-test/prod.yaml
  - image: robot-configurator
    structureTests:
      - docker/robot-configurator/test/container-structure-test/prod.yaml
  - image: monitoring-ui
    structureTests:
      - docker/monitoring-ui/test/container-structure-test/prod.yaml
  - image: order-auctioneer
    structureTests:
      - docker/order-auctioneer/test/container-structure-test/prod.yaml
  - image: order-bid-agent
    structureTests:
      - docker/order-bid-agent/test/container-structure-test/prod.yaml
  - image: mir-runtime-estimator
    structureTests:
      - docker/mir-runtime-estimator/test/container-structure-test/prod.yaml
deploy:
  kubectl:
    manifests:
    - ""

#########################################################################################

profiles:
  ## Build profile to push images to GCR (Google Container Registry). It uses 'eu.gcr.io'
  ## as host and determines your project dynamically via 'gcloud config get-value project'.
  ## Each image gets tagged with the current Unix timestamp and 'latest'.
  - name: gcp
    build: 
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: ewm-sim
          custom:
            buildCommand: ./scripts/gcr-build.sh ewm-sim ./Dockerfile docker/ewm-sim/
            dependencies:
              paths: 
                - .
        - image: dummy-mission-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh dummy-mission-controller docker/dummy-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: mir-mission-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh mir-mission-controller docker/mir-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: fetch-mission-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh fetch-mission-controller docker/fetch-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: order-manager
          custom:
            buildCommand: ./scripts/gcr-build.sh order-manager docker/order-manager/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: robot-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh robot-controller docker/robot-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: robot-configurator
          custom:
            buildCommand: ./scripts/gcr-build.sh robot-configurator docker/robot-configurator/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: monitoring-ui
          custom:
            buildCommand: ./scripts/gcr-build.sh monitoring-ui docker/monitoring-ui/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: order-auctioneer
          custom:
            buildCommand: ./scripts/gcr-build.sh order-auctioneer docker/order-auctioneer/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: order-bid-agent
          custom:
            buildCommand: ./scripts/gcr-build.sh order-bid-agent docker/order-bid-agent/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: mir-runtime-estimator
          custom:
            buildCommand: ./scripts/gcr-build.sh mir-runtime-estimator docker/mir-runtime-estimator/Dockerfile ./
            dependencies:
              paths: 
                - .
  ## Build profile to push images to hub.docker.com (ewmcloudrobotics/<IMAGE>)
  ## Tests are executed to verify that correct Dockerfiles were used
  ## Deploy is left blank since this profile is for updating the container registry.
  ## Used within CI
  - name: dockerhub
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: ewm-sim
          custom:
            buildCommand: ./scripts/dockerhub-build.sh ewm-sim ./Dockerfile docker/ewm-sim/
            dependencies:
              paths: 
                - .
        - image: dummy-mission-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh dummy-mission-controller docker/dummy-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: mir-mission-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh mir-mission-controller docker/mir-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: fetch-mission-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh fetch-mission-controller docker/fetch-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: order-manager
          custom:
            buildCommand: ./scripts/dockerhub-build.sh order-manager docker/order-manager/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: robot-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh robot-controller docker/robot-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: robot-configurator
          custom:
            buildCommand: ./scripts/dockerhub-build.sh robot-configurator docker/robot-configurator/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: monitoring-ui
          custom:
            buildCommand: ./scripts/dockerhub-build.sh monitoring-ui docker/monitoring-ui/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: order-auctioneer
          custom:
            buildCommand: ./scripts/dockerhub-build.sh order-auctioneer docker/order-auctioneer/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: order-bid-agent
          custom:
            buildCommand: ./scripts/dockerhub-build.sh order-bid-agent docker/order-bid-agent/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: mir-runtime-estimator
          custom:
            buildCommand: ./scripts/dockerhub-build.sh mir-runtime-estimator docker/mir-runtime-estimator/Dockerfile ./
            dependencies:
              paths: 
                - .
  ## Profiles to build and push application specific images via deploy.sh to
  ## custom container registry
  ##
  ## ewm-order-manager
  - name: ewm-order-manager
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: order-manager
          custom:
            buildCommand: ./scripts/custom-cr-build.sh order-manager docker/order-manager/Dockerfile ./
            dependencies:
              paths: 
                - .
    test:
      - image: order-manager
        structureTests:
          - docker/order-manager/test/container-structure-test/prod.yaml
  ## ewm-robot-controller
  - name: ewm-robot-controller
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: robot-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh robot-controller docker/robot-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: robot-configurator
          custom:
            buildCommand: ./scripts/custom-cr-build.sh robot-configurator docker/robot-configurator/Dockerfile ./
            dependencies:
              paths: 
                - .
    test:
      - image: robot-controller
        structureTests:
          - docker/robot-controller/test/container-structure-test/prod.yaml
      - image: robot-configurator
        structureTests:
          - docker/robot-configurator/test/container-structure-test/prod.yaml
    ## ewm-monitoring-ui
  - name: ewm-monitoring-ui
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: monitoring-ui
          custom:
            buildCommand: ./scripts/custom-cr-build.sh monitoring-ui docker/monitoring-ui/Dockerfile ./
            dependencies:
              paths: 
                - .
    test:
      - image: monitoring-ui
        structureTests:
          - docker/monitoring-ui/test/container-structure-test/prod.yaml
    ## ewm-order-auction
  - name: ewm-order-auction
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: order-auctioneer
          custom:
            buildCommand: ./scripts/custom-cr-build.sh order-auctioneer docker/order-auctioneer/Dockerfile ./
            dependencies:
              paths: 
                - .
        - image: order-bid-agent
          custom:
            buildCommand: ./scripts/custom-cr-build.sh order-bid-agent docker/order-bid-agent/Dockerfile ./
            dependencies:
              paths: 
                - .
    test:
      - image: order-auctioneer
        structureTests:
          - docker/order-auctioneer/test/container-structure-test/prod.yaml
      - image: order-bid-agent
        structureTests:
          - docker/order-bid-agent/test/container-structure-test/prod.yaml
  ## ewm-sim        
  - name: ewm-sim
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: ewm-sim
          custom:
            buildCommand: ./scripts/custom-cr-build.sh ewm-sim ./Dockerfile docker/ewm-sim/
            dependencies:
              paths: 
                - .
    test:
      - image: ewm-sim
        structureTests:
          - docker/ewm-sim/test/container-structure-test/prod.yaml
  ## mir-mission-controller
  - name: mir-mission-controller
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: mir-mission-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh mir-mission-controller docker/mir-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .      
    test:
      - image: mir-mission-controller
        structureTests:
          - docker/mir-mission-controller/test/container-structure-test/prod.yaml
  ## mir-runtime-estimator
  - name: mir-runtime-estimator
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: mir-runtime-estimator
          custom:
            buildCommand: ./scripts/custom-cr-build.sh mir-runtime-estimator docker/mir-runtime-estimator/Dockerfile ./
            dependencies:
              paths: 
                - .      
    test:
      - image: mir-runtime-estimator
        structureTests:
          - docker/mir-runtime-estimator/test/container-structure-test/prod.yaml
  ## dummy-mission-controller
  - name: dummy-mission-controller
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: dummy-mission-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh dummy-mission-controller docker/dummy-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
    test:
      - image: dummy-mission-controller
        structureTests:
          - docker/dummy-mission-controller/test/container-structure-test/prod.yaml
  ## fetch-mission-controller
  - name: fetch-mission-controller
    build:
      tagPolicy:
        envTemplate:
          template: "{{.IMAGE_NAME}}:dirty"
      artifacts:
        - image: fetch-mission-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh fetch-mission-controller docker/fetch-mission-controller/Dockerfile ./
            dependencies:
              paths: 
                - .
    test:
      - image: fetch-mission-controller
        structureTests:
          - docker/fetch-mission-controller/test/container-structure-test/prod.yaml