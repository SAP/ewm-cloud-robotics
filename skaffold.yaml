##
## Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
##
## This file is part of ewm-cloud-robotics
## (see https://github.com/SAP/ewm-cloud-robotics).
##
## This file is licensed under the Apache Software License, v. 2 except as noted otherwise in the LICENSE file (https://github.com/SAP/ewm-cloud-robotics/blob/main/LICENSE)
##

apiVersion: skaffold/v1beta11
kind: Config

## Default profile:
## Use local Docker daemon & registry to build and test all images, then exit without deployment
## to verify that builds and tests are OK. 
build:
  artifacts:
    - image: ewm-sim
      context: docker/ewm-sim/
      docker:
        dockerfile: Dockerfile
        target: ewm-sim
    - image: dummy-mission-controller
      context: .
      docker:
        dockerfile: Dockerfile
        target: dummy-mission-controller
    - image: fetch-mission-controller
      context: .
      docker:
        dockerfile: Dockerfile
        target: fetch-mission-controller
    - image: mir-mission-controller
      context: .
      docker:
        dockerfile: Dockerfile
        target: mir-mission-controller
    - image: order-manager
      context: .
      docker:
        dockerfile: Dockerfile
        target: order-manager
    - image: robot-controller
      context: .
      docker:
        dockerfile: Dockerfile
        target: robot-controller
    - image: robot-configurator
      context: .
      docker:
        dockerfile: Dockerfile
        target: robot-configurator
    - image: monitoring-ui
      context: .
      docker:
        dockerfile: Dockerfile
        target: monitoring-ui
    - image: order-auctioneer
      context: .
      docker:
        dockerfile: Dockerfile
        target: order-auctioneer
    - image: order-bid-agent
      context: .
      docker:
        dockerfile: Dockerfile
        target: order-bid-agent
    - image: mir-travel-time-calculator
      context: .
      docker:
        dockerfile: Dockerfile
        target: mir-travel-time-calculator
  local: 
    push: false
test:
  - image: ewm-sim
    structureTests:
      - tests/container-structure-tests/ewm-sim.yaml
  - image: dummy-mission-controller
    structureTests:
      - tests/container-structure-tests/dummy-mission-controller.yaml
  - image: mir-mission-controller
    structureTests:
      - tests/container-structure-tests/mir-mission-controller.yaml
  - image: fetch-mission-controller
    structureTests:
      - tests/container-structure-tests/fetch-mission-controller.yaml
  - image: order-manager
    structureTests:
      - tests/container-structure-tests/order-manager.yaml
  - image: robot-controller
    structureTests:
      - tests/container-structure-tests/robot-controller.yaml
  - image: robot-configurator
    structureTests:
      - tests/container-structure-tests/robot-configurator.yaml
  - image: monitoring-ui
    structureTests:
      - tests/container-structure-tests/monitoring-ui.yaml
  - image: order-auctioneer
    structureTests:
      - tests/container-structure-tests/order-auctioneer.yaml
  - image: order-bid-agent
    structureTests:
      - tests/container-structure-tests/order-bid-agent.yaml
  - image: mir-travel-time-calculator
    structureTests:
      - tests/container-structure-tests/mir-travel-time-calculator.yaml

#########################################################################################

profiles:
  ## Build profile to push images to GCR (Google Container Registry). It uses 'eu.gcr.io'
  ## as host and determines your project dynamically via 'gcloud config get-value project'.
  ## Each image gets tagged with the current Unix timestamp and 'latest'.
  - name: gcp
    build: 
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: ewm-sim
          custom:
            buildCommand: ./scripts/gcr-build.sh ewm-sim ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: dummy-mission-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh dummy-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: mir-mission-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh mir-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: fetch-mission-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh fetch-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: order-manager
          custom:
            buildCommand: ./scripts/gcr-build.sh order-manager ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: robot-controller
          custom:
            buildCommand: ./scripts/gcr-build.sh robot-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: robot-configurator
          custom:
            buildCommand: ./scripts/gcr-build.sh robot-configurator ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: monitoring-ui
          custom:
            buildCommand: ./scripts/gcr-build.sh monitoring-ui ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: order-auctioneer
          custom:
            buildCommand: ./scripts/gcr-build.sh order-auctioneer ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: order-bid-agent
          custom:
            buildCommand: ./scripts/gcr-build.sh order-bid-agent ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: mir-travel-time-calculator
          custom:
            buildCommand: ./scripts/gcr-build.sh mir-travel-time-calculator ./Dockerfile
            dependencies:
              paths: 
                - .
  ## Build profile to push images to hub.docker.com (ewmcloudrobotics/<IMAGE>)
  ## Tests are executed to verify that correct Dockerfiles were used
  ## Deploy is left blank since this profile is for updating the container registry.
  ## Used within CI
  - name: dockerhub
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: ewm-sim
          custom:
            buildCommand: ./scripts/dockerhub-build.sh ewm-sim ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: dummy-mission-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh dummy-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: mir-mission-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh mir-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: fetch-mission-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh fetch-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: order-manager
          custom:
            buildCommand: ./scripts/dockerhub-build.sh order-manager ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: robot-controller
          custom:
            buildCommand: ./scripts/dockerhub-build.sh robot-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: robot-configurator
          custom:
            buildCommand: ./scripts/dockerhub-build.sh robot-configurator ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: monitoring-ui
          custom:
            buildCommand: ./scripts/dockerhub-build.sh monitoring-ui ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: order-auctioneer
          custom:
            buildCommand: ./scripts/dockerhub-build.sh order-auctioneer ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: order-bid-agent
          custom:
            buildCommand: ./scripts/dockerhub-build.sh order-bid-agent ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: mir-travel-time-calculator
          custom:
            buildCommand: ./scripts/dockerhub-build.sh mir-travel-time-calculator ./Dockerfile
            dependencies:
              paths: 
                - .
  ## Profiles to build and push application specific images via deploy.sh to
  ## custom container registry
  ##
  ## ewm-order-manager
  - name: ewm-order-manager
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: order-manager
          custom:
            buildCommand: ./scripts/custom-cr-build.sh order-manager ./Dockerfile
            dependencies:
              paths: 
                - .
    test:
      - image: order-manager
        structureTests:
          - tests/container-structure-tests/order-manager.yaml
  ## ewm-robot-controller
  - name: ewm-robot-controller
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: robot-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh robot-controller ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: robot-configurator
          custom:
            buildCommand: ./scripts/custom-cr-build.sh robot-configurator ./Dockerfile
            dependencies:
              paths: 
                - .
    test:
      - image: robot-controller
        structureTests:
          - tests/container-structure-tests/robot-controller.yaml
      - image: robot-configurator
        structureTests:
          - tests/container-structure-tests/robot-configurator.yaml
    ## ewm-monitoring-ui
  - name: ewm-monitoring-ui
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: monitoring-ui
          custom:
            buildCommand: ./scripts/custom-cr-build.sh monitoring-ui ./Dockerfile
            dependencies:
              paths: 
                - .
    test:
      - image: monitoring-ui
        structureTests:
          - tests/container-structure-tests/monitoring-ui.yaml
    ## ewm-order-auction
  - name: ewm-order-auction
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: order-auctioneer
          custom:
            buildCommand: ./scripts/custom-cr-build.sh order-auctioneer ./Dockerfile
            dependencies:
              paths: 
                - .
        - image: order-bid-agent
          custom:
            buildCommand: ./scripts/custom-cr-build.sh order-bid-agent ./Dockerfile
            dependencies:
              paths: 
                - .
    test:
      - image: order-auctioneer
        structureTests:
          - tests/container-structure-tests/order-auctioneer.yaml
      - image: order-bid-agent
        structureTests:
          - tests/container-structure-tests/order-bid-agent.yaml
  ## ewm-sim        
  - name: ewm-sim
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: ewm-sim
          custom:
            buildCommand: ./scripts/custom-cr-build.sh ewm-sim ./Dockerfile
            dependencies:
              paths: 
                - .
    test:
      - image: ewm-sim
        structureTests:
          - tests/container-structure-tests/ewm-sim.yaml
  ## mir-mission-controller
  - name: mir-mission-controller
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: mir-mission-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh mir-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .      
    test:
      - image: mir-mission-controller
        structureTests:
          - tests/container-structure-tests/mir-mission-controller.yaml
  ## mir-travel-time-calculator
  - name: mir-travel-time-calculator
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: mir-travel-time-calculator
          custom:
            buildCommand: ./scripts/custom-cr-build.sh mir-travel-time-calculator ./Dockerfile
            dependencies:
              paths: 
                - .      
    test:
      - image: mir-travel-time-calculator
        structureTests:
          - tests/container-structure-tests/mir-travel-time-calculator.yaml
  ## dummy-mission-controller
  - name: dummy-mission-controller
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: dummy-mission-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh dummy-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
    test:
      - image: dummy-mission-controller
        structureTests:
          - tests/container-structure-tests/dummy-mission-controller.yaml
  ## fetch-mission-controller
  - name: fetch-mission-controller
    build:
      tagPolicy:
        envTemplate:
          template: "dirty"
      artifacts:
        - image: fetch-mission-controller
          custom:
            buildCommand: ./scripts/custom-cr-build.sh fetch-mission-controller ./Dockerfile
            dependencies:
              paths: 
                - .
    test:
      - image: fetch-mission-controller
        structureTests:
          - tests/container-structure-tests/fetch-mission-controller.yaml
